<%= form_for @provider_product, html: { class: 'form' } do |f| %>
<%= render 'shared/error_messages', object: f.object %>

<div class="row">
  <div class="col-md-4">
    <div class="form-group label-floating">
      <%= f.label :hash_id, class: 'control-label' %>
      <%= f.text_field :hash_id, class: 'form-control', disabled: true %>
    </div>
  </div>
  <div class="col-md-4">
    <div class="form-group label-floating">
      <%= label_tag :main_category, t('.main_category'), class: 'control-label' %>
      <%= select_tag :main_category, options_from_collection_for_select(@categories, :hash_id, :name),
        prompt: '', class: 'form-control', required: true, onchange: 'fetchSubcategories(this);' %>
    </div>
  </div>
  <div class="col-md-4">
    <div class="form-group label-floating">
      <%= f.label :product_category_id, t('.subcategory'), class: 'control-label' %>
      <%= select_tag 'provider_product[product_category_id]', nil,
        class: 'form-control', required: true, onchange: 'updateName(this);' %>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-6">
    <div class="form-group label-floating">
      <%= f.label :name, class: 'control-label' %>
      <%= f.text_field :name, class: 'form-control', required: true %>
    </div>
  </div>
  <div class="col-md-6">
    <div class="form-group label-floating">
      <%= f.label :presentation, class: 'control-label' %>
      <%= f.text_field :presentation, class: 'form-control', required: true %>
    </div>
  </div>
</div>

<%= f.submit t(:save), class: 'btn btn-primary pull-right remove-on-show' %>
<div class="clearfix"></div>
<% end %>

<script type="text/javascript">
function fetchSubcategories(trigger){
  hash_id = $(trigger).find(":selected").val();
  base_url = "<%= product_categories_path(parent: 'replace_with_id', format: :json) %>";
  url = base_url.replace("replace_with_id", hash_id)
  $.ajax({
    url: url,
    context: document.body
  }).done(function(body) {
    updateSubcategories(body);
  });
}

function updateSubcategories(subcategories){
  select = $("#provider_product_product_category_id");
  select.html("");

  if(subcategories.length == 0){
    notification.new("info", "<%= t('.subcategories_not_found') %>");
    return;
  }

  select.append(selectOption("", ""));
  for (var i = 0; i < subcategories.length; i++) {
    obj = subcategories[i];
    select.append(selectOption(obj.name, obj.id))
  }
}

function selectOption(label, value){
  option = "<option value=\""+value+"\">"+label+"</option>"
  return option;
}

function updateName(trigger){
  name_field = $("#provider_product_name");
  // if it is already filled, do nothing
  if(name_field.val().length > 0)
    return;

  name = $(trigger).find(":selected").text();
  name_field.val(name);
  name_field.parent().removeClass("is-empty");
}
</script>
